" # Modeline {
" Rules only for this file
" vim: set sw=2 ts=2 sts=2 tw=78 foldmarker={,} foldmethod=marker spell:
" }
" # Environment {

let home = $HOME    " For convenience

" ## Identify platform {
silent function! MAC()
  return has('macunix')
endfunction
silent function! LINUX()
  return has('unix') && !has('macunix') && !has('win32unix')
endfunction

" }

" }
" # Plugins {

" ## Plug setup {

" Automatically install Plug
if empty(glob('~/.vim/autoload/plug.vim'))
  silent !curl -fLo ~/.vim/autoload/plug.vim --create-dirs
    \ https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  autocmd VimEnter * PlugInstall --sync | source $MYVIMRC
endif

" Initialize Plug
call plug#begin('~/.vim/plugged')

" }

" ## Install plugins {

" Nicer TMUX pane movements
Plug 'christoomey/vim-tmux-navigator'

Plug 'tpope/vim-sensible'

Plug 'SirVer/ultisnips'
Plug 'mattn/emmet-vim'
Plug 'jiangmiao/auto-pairs'
Plug 'tpope/vim-repeat'   " Allows to make the repeat (.) command smarter
Plug 'tpope/vim-surround'   " Surround stuff with braces, quotes, tags, anything
Plug 'machakann/vim-highlightedyank'  " Highlight yanked text briefly

Plug 'scrooloose/nerdtree'
Plug 'itchyny/lightline.vim'
Plug 'mhinz/vim-startify'

" FZF - fuzzy search
if executable('/usr/local/opt/fzf')
  Plug '/usr/local/opt/fzf'
else
  Plug 'junegunn/fzf', { 'dir': '~/.fzf', 'do': './install --all' }
endif
Plug 'junegunn/fzf.vim'

" Deoplete - autocompletion
if has('nvim')
  Plug 'Shougo/deoplete.nvim', { 'do': ':UpdateRemotePlugins' }
else
  Plug 'Shougo/deoplete.nvim'
  Plug 'roxma/nvim-yarp'
  Plug 'roxma/vim-hug-neovim-rpc'
endif
" LanguageClient - LSP client app
" Plug 'autozimu/LanguageClient-neovim', {
"       \ 'branch': 'next',
"       \ 'do': 'bash install.sh',
"       \ }

"
" Colors
"

Plug 'joshdick/onedark.vim'


"
" Programming
"

Plug 'tpope/vim-commentary'   " Comment stuff out easily
Plug 'sheerun/vim-polyglot'   " Syntax highlighting for most file types
Plug 'ludovicchabant/vim-gutentags'   " Manage tags file

Plug 'tpope/vim-fugitive'   " Git integrations
Plug 'airblade/vim-gitgutter'   " Show Git modified lines in the gutter

" Typescript support (client for tsserver)
Plug 'mhartington/nvim-typescript', {'do': './install.sh'}
Plug 'peitalin/vim-jsx-typescript'
Plug 'HerringtonDarkholme/yats.vim'
Plug 'styled-components/vim-styled-components', { 'branch': 'main' }

" Plug 'pangloss/vim-javascript'
" Plug 'maxmellon/vim-jsx-pretty'   " Nicer JSX syntax highlighting

Plug 'ap/vim-css-color'

Plug 'alvan/vim-closetag'

Plug 'w0rp/ale'


"
" Text editing
"

Plug 'iamcco/markdown-preview.nvim', { 'do': 'cd app & yarn install'  }

" LaTeX
Plug 'lervag/vimtex'
Plug 'xuhdev/vim-latex-live-preview', { 'for': 'tex' }


" Always load this last!
Plug 'ryanoasis/vim-devicons'


" End initialization
call plug#end()

" }

" }
" # General {

nnoremap <space> <nop>
let mapleader="\<Space>"
let maplocalleader="\\"

" Integration with the system clipboard
if has('clipboard')
  if has('unnamedplus')
    " When possible, use the + register for copy/paste
    set clipboard=unnamed,unnamedplus
  else
    " On Mac and Windows, use the * register
    set clipboard=unnamed
  endif
endif

" }
" # Vim UI {

" Customize onedark colors
function! CustomizeColors()
  let s:colors = onedark#GetColors()
  " Cannot use s:colors.yellow for some reason so let's copy it here :(
  let s:yellow = { "gui": "#E5C07B", "cterm": "180", "cterm16": "3" }
  let s:red = { "gui": "#E06C75", "cterm": "204", "cterm16": "1" }

  " Purple const/var/let, etc.
  call onedark#extend_highlight("StorageClass", { "fg": s:colors.purple })

  " Nicer parenthesis match
  call onedark#set_highlight("MatchParen", { "bg": s:colors.menu_grey })
  " Red TSX opening tag
  call onedark#set_highlight("tsxTagName", { "fg": s:colors.red })
  call onedark#set_highlight("tsxAttrib", { "fg": s:yellow })
  " Less crazy search highlight
  call onedark#set_highlight("Search", { "bg": s:colors.menu_grey })
  " Consistent Typescript parenthesis
  call onedark#set_highlight("typescriptParens", { "fg": s:colors.white })
  call onedark#set_highlight("typescriptVariable", { "fg": s:colors.purple })
  call onedark#set_highlight("typescriptCall", { "fg": s:colors.white })
  call onedark#set_highlight("typescriptImport", { "fg": s:colors.purple })
  call onedark#set_highlight("typescriptIdentifierName", { "fg": s:colors.red })
  call onedark#set_highlight("typescriptInterfaceKeyword", { "fg": s:colors.purple })
  call onedark#set_highlight("typescriptInterfaceName", { "fg": s:yellow })
  call onedark#set_highlight("typescriptInterfaceExtends", { "fg": s:colors.purple })
  call onedark#set_highlight("typescriptTypeReference", { "fg": s:yellow })
  call onedark#set_highlight("typescriptVariableDeclaration", { "fg": s:yellow })
  call onedark#set_highlight("styledPrefix", { "fg": s:red })
  call onedark#set_highlight("jsTemplateBraces", { "fg": s:colors.purple })
  call onedark#set_highlight("typescriptFuncTypeArrow", { "fg": s:colors.purple })
  call onedark#set_highlight("typescriptExport", { "fg": s:colors.purple })
  call onedark#set_highlight("typescriptAliasKeyword", { "fg": s:colors.purple })
  call onedark#set_highlight("typescriptAliasDeclaration", { "fg": s:yellow })
endfunc

if (has("autocmd"))
  augroup colorextend
    autocmd!
    autocmd ColorScheme * call CustomizeColors()
  augroup END
endif

colorscheme onedark

" }
" # Neovim {

" Neovim specific settings
if has('nvim')
  if (has("termguicolors"))
    set termguicolors
  endif

  if (empty($TMUX))
    " Use 24-bit (true-color) mode
    let $NVIM_TUI_ENABLE_TRUE_COLOR=1

    " Nvim terminal keybindings
    tnoremap <Esc> <C-\><C-n>
    tnoremap <M-[> <Esc>
    tnoremap <C-v><Esc> <Esc>
  endif
endif

" }
